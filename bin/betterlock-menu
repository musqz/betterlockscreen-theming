#!/usr/bin/env bash 

# Configuratie
CONFIG_DIR="$HOME/.config/betterlockscreen"
THEMES_DIR="$CONFIG_DIR/themes"
ICON="$HOME/.icons/mabox-logo-3d.svg"

ACTIVE_THEME="$(cat /tmp/betterlock-theme | sed 's/.*\///; s/\.[^.]*$//')"

# Detecteer language
LANG_SHORT="${LANG:0:2}"

# Dependency check
command -v yad >/dev/null 2>&1 || {
    echo "Error: yad is not installed." >&2
    exit 1
}

command -v betterlockscreen >/dev/null 2>&1 || {
    echo "Warning: betterlockscreen not found. Some actions won't work." >&2
}

case "$LANG_SHORT" in
    nl)
        TITLE="Betterlockscreen Thema Manager"
        TXT_CHOOSE_ACTION="Kies een actie:"
        TXT_SELECT_THEME="Thema Kiezen"
        TXT_REGENERATE="Genereer Thema"
        TXT_HELP="Help"
        TXT_EXIT="Afsluiten"
        TXT_OK="Sluiten"
        TXT_CHOOSE_THEME="Kies een bestaand thema:"
        TXT_NO_THEMES="Geen thema's gevonden in $THEMES_DIR"
        TXT_HELP_TEXT_NL="<b>[LANGZAAM PROCES] betterlockscreen -u [afbeeldingspad]:</b>\n
Werk je vergrendelingsscherm bij, inclusief achtergrond en schaduw van het inlogvak.\n
Optioneel: specificeer een aangepaste afbeelding; laat leeg om de standaard Mabox-achtergrond te gebruiken.\n\n
<b>[SNEL PROCES] betterlockscreen -l:</b>\n
Bekijk direct nieuwe wijzigingen (lettertypen, kleuren) zonder achtergrond of schaduw van het inlogvak te vernieuwen.\n\n
<b>betterlock-theme-generator:</b>\n
Maak interactief nieuwe kleurenthema‚Äôs. Kies stijl, lettertype, welkomsttekst en bekijk het inlogvak voordat je opslaat.\n\n
<b>betterlock-themes:</b>\n
Selecteer en activeer opgeslagen thema‚Äôs in ~/.config/betterlockscreen/themes/. Wordt direct toegepast of met volledige achtergrondvernieuwing.\n\n
<b>betterlock-menu:</b>\n
Start de GUI om thema‚Äôs te genereren, thema‚Äôs te kiezen, het scherm te vergrendelen of Mabox Betterlockscreen-instellingen te openen.\n\n
<b>Mabox sneltoetsen:</b>\n
  W-A-l : Open Betterlockscreen-instellingen\n
  W-l   : Vergrendel het scherm direct\n"

        ;;
    pl)
        TITLE="Mened≈ºer Motyw√≥w Betterlockscreen"
        TXT_CHOOSE_ACTION="Wybierz akcjƒô:"
        TXT_SELECT_THEME="Wybierz Motyw"
        TXT_REGENERATE="Generuj Motyw"
        TXT_HELP="Pomoc"
        TXT_EXIT="Zako≈Ñcz"
        TXT_OK="Zamknij"
        TXT_CHOOSE_THEME="Wybierz istniejƒÖcy motyw:"
        TXT_NO_THEMES="Nie znaleziono motyw√≥w w $THEMES_DIR"
        TXT_HELP_TEXT_PL="<b>[WOLNY PROCES] betterlockscreen -u [≈õcie≈ºka_obrazu]:</b>\n
Aktualizuje ekran blokady, w tym t≈Ço i cie≈Ñ okna logowania.\n
Opcjonalnie podaj w≈Çasny obraz; pozostaw puste, aby u≈ºyƒá domy≈õlnej tapety Mabox.\n\n
<b>[SZYBKI PROCES] betterlockscreen -l:</b>\n
Natychmiast poka≈º nowe zmiany (czcionki, kolory) bez regenerowania t≈Ça lub cienia okna logowania.\n\n
<b>betterlock-theme-generator:</b>\n
Interaktywnie tw√≥rz nowe motywy kolorystyczne. Wybierz styl, czcionkƒô, tekst powitalny i podglƒÖd okna logowania przed zapisaniem.\n\n
<b>betterlock-themes:</b>\n
Wybierz i zastosuj zapisane motywy z ~/.config/betterlockscreen/themes/. Zastosowanie natychmiastowe lub z pe≈ÇnƒÖ regeneracjƒÖ t≈Ça.\n\n
<b>betterlock-menu:</b>\n
Uruchom GUI, aby generowaƒá motywy, wybieraƒá motywy, blokowaƒá ekran lub otworzyƒá ustawienia Betterlockscreen Mabox.\n\n
<b>Skr√≥ty klawiszowe Mabox:</b>\n
  W-A-l : Otw√≥rz ustawienia Betterlockscreen\n
  W-l   : Natychmiast zablokuj ekran\n"

        ;;
    es)
        TITLE="Betterlockscreen Gestor de Temas"
        TXT_CHOOSE_ACTION="Elige una acci√≥n:"
        TXT_SELECT_THEME="Seleccionar Tema"
        TXT_REGENERATE="Generar Tema"
        TXT_HELP="Ayuda"
        TXT_EXIT="Salir"
        TXT_OK="Cerrar"
        TXT_CHOOSE_THEME="Selecciona un tema existente:"
        TXT_NO_THEMES="No se encontraron temas en $THEMES_DIR"
        TXT_HELP_TEXT_ES="<b>[PROCESO LENTO] betterlockscreen -u [ruta_imagen]:</b>\n
Actualiza la imagen de la pantalla de bloqueo, incluyendo el fondo y la sombra del cuadro de inicio de sesi√≥n.\n
Opcionalmente, especifica una imagen personalizada; deja vac√≠o para usar el fondo de pantalla de Mabox.\n\n
<b>[PROCESO R√ÅPIDO] betterlockscreen -l:</b>\n
Muestra instant√°neamente los cambios nuevos (fuentes, colores) sin regenerar el fondo ni la sombra del cuadro de inicio de sesi√≥n.\n\n
<b>betterlock-theme-generator:</b>\n
Crea interactivamente nuevos temas de color. Elige estilo, fuente, texto de bienvenida y vista previa del cuadro de inicio antes de guardar.\n\n
<b>betterlock-themes:</b>\n
Selecciona y aplica los temas guardados en ~/.config/betterlockscreen/themes/. Se aplica al instante o con regeneraci√≥n completa del fondo de pantalla.\n\n
<b>betterlock-menu:</b>\n
Lanza la GUI para generar temas, elegir temas, bloquear la pantalla o abrir la configuraci√≥n de Betterlockscreen de Mabox.\n\n
<b>Atajos de Mabox:</b>\n
  W-A-l : Abrir la configuraci√≥n de Betterlockscreen\n
  W-l   : Bloquear la pantalla al instante\n"

        ;;
    *)
        TITLE="Betterlockscreen Theme Manager"
        TXT_CHOOSE_ACTION="Choose an action:"
        TXT_SELECT_THEME="Select Theme"
        TXT_REGENERATE="Generate Theme"
        TXT_HELP="Help"
        TXT_EXIT="Exit"
        TXT_OK="Close"
        TXT_CHOOSE_THEME="Choose an existing theme:"
        TXT_NO_THEMES="No themes found in $THEMES_DIR"
        TXT_HELP_TEXT="<b>[SLOW PROCESS] betterlockscreen -u [image_path]:</b>\n
Updates your lockscreen image including loginbox background and shadow.\n
Optionally specify a custom image; leave empty to use the Mabox wallpaper.\n\n
<b>[QUICK PROCESS] betterlockscreen -l:</b>\n
See instantly new changes (fonts, colors) without regenerating loginbox background or shadow.\n\n
<b>betterlock-theme-generator:</b>\n
Interactively create new color themes. Choose style, font, greeter text, and preview loginbox colors before saving.\n\n
<b>betterlock-themes:</b>\n
Select and apply saved themes from ~/.config/betterlockscreen/themes/. Applies instantly or with full wallpaper regeneration.\n\n
<b>betterlock-menu:</b>\n
Launch GUI to generate themes, choose themes, lock the screen, or open Mabox Betterlockscreen settings.\n\n
<b>Mabox hotkeys:</b>\n
  W-A-l : Open Betterlockscreen settings\n
  W-l   : Lock screen instantly\n"
        TXT_ACTIVE_THEME="<b>Active theme: </b>"
        ;;
esac

# üìò Functies

get_header_image() {
    local cache="$HOME/.cache/betterlockscreen/current/wall_resize.png"
    local out="/tmp/yad-header.png"

    local geom=$(xrandr | awk '/ primary / {print $4}' | cut -d+ -f1)
    local w=$(echo $geom | cut -dx -f1)
    local h=$(echo $geom | cut -dx -f2)

    magick "$cache" -crop "${w}x${h}+0+0" +repage \
        -resize 350x120^ \
        -gravity center -extent 350x155 \
        "$out"

    echo "$out"
}

HEADER_IMG=$(get_header_image)


        
show_help() {
    yad --form --width=600 --height=650 --center --title="$TXT_HELP" \
 --window-icon=$ICON \
    --field="Help:TXT" "$(echo -e "$TXT_HELP_TEXT")!" --button="$TXT_OK:0"
}

show_main_menu() {
    yad --width=350 --height=220 --center \
        --title="$TITLE" \
        --window-icon="$ICON" \
        --image="$HEADER_IMG" \
        --text="<b>$TITLE</b>\n\n$TXT_ACTIVE_THEME $ACTIVE_THEME\n\n\n$TXT_CHOOSE_ACTION" \
        --text-align=center \
        --button="üé® $TXT_SELECT_THEME:1" \
        --button="üõ†Ô∏è $TXT_REGENERATE:2" \
        --button="üõà $TXT_HELP:3" \
        --button="üö™ $TXT_EXIT:0"

    case $? in
        1) betterlock-themes ; betterlock-menu ;;
        2) betterlock-theme-generator ; betterlock-menu ;;
        3) show_help; show_main_menu ;;
        0) exit 0 ;;
    esac
}

# Start
show_main_menu
