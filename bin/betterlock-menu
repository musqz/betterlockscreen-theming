#!/usr/bin/env bash
set -euo pipefail

##############################################
# Configuration
##############################################

CONFIG_DIR="$HOME/.config/betterlockscreen"
THEMES_DIR="$CONFIG_DIR/themes"
WALLPAPER_DIR="$CONFIG_DIR/wallpapers"

[ -f "$CONFIG_DIR/config" ] && . "$CONFIG_DIR/config"

##############################################
# Dependency checks
##############################################

command -v yad >/dev/null 2>&1 || {
    echo "Error: yad is not installed." >&2
    exit 1
}

command -v betterlockscreen >/dev/null 2>&1 || {
    echo "Warning: betterlockscreen not found. Some actions won't work." >&2
}

##############################################
# Helpers
##############################################

err() {
    yad --title="Fout" \
        --text="$1" \
        --center \
        --button="OK:0" \
        --width=300 \
        --height=100
}

choose_from_list() {
    local title="$1"
    shift

    local items=("$@")
    local list_entries=()

    for it in "${items[@]}"; do
        list_entries+=("$it")
    done

    yad --title="$title" \
        --list \
        --column="Optie" \
        --height=400 \
        --width=300 \
        --center \
        --print-column=1 \
        -- "${list_entries[@]}"
}

##############################################
# Theme selection
##############################################

choose_theme() {
    if [ ! -d "$THEMES_DIR" ]; then
        err "Geen thema-map gevonden."
        return 1
    fi

    local themes=()
    for t in "$THEMES_DIR"/*; do
        [ -d "$t" ] && themes+=("$(basename "$t")")
    done

    if [ "${#themes[@]}" -eq 0 ]; then
        err "Geen thema's gevonden."
        return 1
    fi

    local choice
    choice="$(choose_from_list 'Kies thema' "${themes[@]}")" || return 1

    [ -z "$choice" ] && return 1

    betterlockscreen -u "$THEMES_DIR/$choice" || err "Kon thema niet toepassen."
}

##############################################
# Wallpaper selection
##############################################

choose_wallpaper() {
    if [ ! -d "$WALLPAPER_DIR" ]; then
        err "Geen wallpaper-map gevonden."
        return 1
    fi

    local walls=()
    for w in "$WALLPAPER_DIR"/*; do
        [ -f "$w" ] && walls+=("$(basename "$w")")
    done

    if [ "${#walls[@]}" -eq 0 ]; then
        err "Geen wallpapers gevonden."
        return 1
    fi

    local choice
    choice="$(choose_from_list 'Kies wallpaper' "${walls[@]}")" || return 1

    [ -z "$choice" ] && return 1

    betterlockscreen -u "$WALLPAPER_DIR/$choice" || err "Kon wallpaper niet toepassen."
}

##############################################
# Lock screen
##############################################

lock_screen() {
    betterlockscreen -l || err "Kon scherm niet vergrendelen."
}

##############################################
# Settings menu
##############################################

settings_menu() {
    local options=(
        "Update theme"
        "Update wallpaper"
        "Regenerate cached images"
    )

    local choice
    choice="$(choose_from_list 'Instellingen' "${options[@]}")" || return 1

    case "$choice" in
        "Update theme") choose_theme ;;
        "Update wallpaper") choose_wallpaper ;;
        "Regenerate cached images")
            betterlockscreen -r || err "Kon cache niet regenereren."
            ;;
    esac
}

##############################################
# Main menu
##############################################

main_menu() {
    local options=(
        "Vergrendel scherm"
        "Kies thema"
        "Kies wallpaper"
        "Instellingen"
        "Afsluiten"
    )

    local choice
    choice="$(choose_from_list 'Betterlock Menu' "${options[@]}")" || exit 0

    case "$choice" in
        "Vergrendel scherm") lock_screen ;;
        "Kies thema") choose_theme ;;
        "Kies wallpaper") choose_wallpaper ;;
        "Instellingen") settings_menu ;;
        "Afsluiten") exit 0 ;;
    esac
}

##############################################
# Run
##############################################

main_menu
