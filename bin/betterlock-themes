#!/bin/bash

# Made with and for Mabox linux systems.
# Betterlock-Themes - Theme Chooser + Optional Image Cache Updater
# Needed scripts: betterlock-theme-generator, betterlock-themes.

THEME_DIR="$HOME/.config/betterlockscreen/themes"
OUTPUT_FILE="$HOME/.config/betterlockscreen/betterlockscreenrc"
ICON="$HOME/.icons/mb-logo-3d.svg"


case $LANG in
nl*)
	TITLE="Afbeeldingen cachen voor snellere schermvergrendeling"
	TEXT="\nEven geduld...\ndit kan een paar seconden duren..."
	TITLE2="Klaar"
	TEXT2="Alle benodigde wijzigingen zijn toegepast.\n Gebruik <b>super + l</b> om het scherm te vergrendelen."
	CHECK_LABEL="Achtergrond en kleuren nu bijwerken (langzamer)."
	_SELECT_THEME="Selecteer Betterlockscreen-thema"
	_ERROR="Het geselecteerde thema kon niet worden gevonden!"
	_OPTIONS="Betterlockscreen-opties"
	_SELECT="Selecteer"
	_THEME="Thema"
	;;
es*)
	TITLE="Generando imágenes para el bloqueo de pantalla"
	TEXT="\nPor favor espera...\nesto puede tardar unos segundos..."
	TITLE2="Listo"
	TEXT2="Todos los cambios se han aplicado.\n Usa <b>super + l</b> para bloquear la pantalla."
	CHECK_LABEL="Actualizar fondo e imagen ahora (más lento)."
	_SELECT_THEME="Seleccionar tema de Betterlockscreen"
	_ERROR="¡El tema seleccionado no se pudo encontrar!"
	_OPTIONS="Opciones de Betterlockscreen"
	_SELECT="Seleccionar"
	_THEME="Tema"
	;;
pl*)
    TITLE="Tworzenie obrazków dla blokady ekranu"
    TEXT="\nCierpliwości...\nto może chwilkę potrwać..."
    TITLE2="Gotowe"
    TEXT2="Wszystkie zmiany zostały zastosowane.\n Użyj <b>super + l</b>, aby zablokować ekran."
    CHECK_LABEL="Zaktualizuj tło i kolory teraz (wolniejsze)"
    _SELECT_THEME="Wybierz motyw Betterlockscreen"
    _ERROR="Nie można znaleźć wybranego motywu!"
    _OPTIONS="Opcje Betterlockscreen"
    _SELECT="Wybierz"
    _THEME="Motyw"
    ;;
*)
    TITLE="Caching images for faster screen locking"
    TEXT="\nPlease wait...\nthis might take few seconds..."
    TITLE2="Done"
    TEXT2="All required changes have been applied.\n Use <b>super + l</b> to lock screen."
    CHECK_LABEL="Update image and loginbox background now (slower)."
    _SELECT_THEME="Select Betterlockscreen Theme"
    _ERROR="The selected theme could not be found!"
    _OPTIONS="Betterlockscreen Options"
    _SELECT="Select"
    _THEME="Theme"
    ;;
esac


# Verzamel alle .theme-bestanden
mapfile -t THEMES < <(find "$THEME_DIR" -maxdepth 1 -type f -name "*.theme" -exec basename {} .theme \; | sort)

# Selectie via YAD
SELECTED=$(yad --list \
  --window-icon=$ICON \
  --title="$_SELECT_THEME" \
  --width=400 --height=300 \
  --column="$_THEME" "${THEMES[@]}" \
  --separator="" \
  --center \
  --button="$_SELECT:0" --button="Cancel:1")

# Annuleer als niks gekozen is
[[ $? -ne 0 || -z "$SELECTED" ]] && exit 1

# Thema pad opzoeken
SELECTED_FILE="$THEME_DIR/$SELECTED.theme"

# Vraag of gebruiker ook -u wil doen en eventueel achtergrondpad
DO_UPDATE=$(yad --form \
  --window-icon=$ICON \
  --title="$_OPTIONS" \
  --center \
  --field="$CHECK_LABEL:CHK" FALSE \
  --field="Custom Background Path:FL" "" \
  --separator="|" \
  --button="OK:0" --button="Cancel:1" \
  --width=500 \
  --height=100 \
  --align=center)

[[ $? -ne 0 ]] && exit 1

# Haal waarde uit checkbox en textfield
UPDATE_IMAGE=$(echo "$DO_UPDATE" | cut -d"|" -f1)
CUSTOM_BG=$(echo "$DO_UPDATE" | cut -d"|" -f2)

# Thema controleren en wegschrijven
if [[ -f "$SELECTED_FILE" ]]; then
  cp "$SELECTED_FILE" "$OUTPUT_FILE"
  
  if [[ "$UPDATE_IMAGE" == "TRUE" ]]; then
    # Gebruik opgegeven achtergrond als die er is, anders default wallpaper
    if [[ -n "$CUSTOM_BG" && -f "$CUSTOM_BG" ]]; then
        BG_PATH="$CUSTOM_BG"
    else
        source <(grep file ~/.config/nitrogen/bg-saved.cfg)
        BG_PATH="$file"
    fi
    
    notify-send.sh -u critical -i emblem-photos -R /tmp/mbscreencache "$TITLE" "$TEXT"
    betterlockscreen -u "$BG_PATH"
    notify-send.sh -u normal -i emblem-photos -R /tmp/mbscreencache "$TITLE2" "$TEXT2"
  fi

  betterlockscreen -l
else
  yad --error --text="$_ERROR" --center --timeout=3
  exit 1
fi
